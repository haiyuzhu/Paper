%% Thesis Template of Nanjing University
%%   for using NJUthesis package with LaTeX2e
%%
%% Created by Wenbo Yang <http://solrex.org>
%% Homepage: http://share.solrex.org/njuthesis/
%%
%% $Id: template.tex,v 0.2 2010/05/01 Exp $


\documentclass[dvipdfmx, oneside, master]{NJUthesis}
% 可选参数：
%   nobackinfo 取消封二页导师签名信息
%   oneside/twoside 单面/双面打印
%   phd/master 博士/硕士论文
% 下面三个选一个：
% dvipdfm 使用 dvipdfm(x) 生成最终的 PDF 文档 (缺省设置，不建议修改)
% dvips 使用 dvips 生成最终的 PS 文档
% pdftex 使用 pdfLaTeX 生成最终的 PDF 文档

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 导言区
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 小节标题靠左对齐
\CTEXsetup[format+={\flushleft}]{section}

% 设置链接颜色
\hypersetup{
% pdf 属性
             pdftitle={Dynamic Human Body Modeling Using a Single RGB~Camera}, %
            pdfauthor={Haiyu Zhu}
}

% 表格
\usepackage{longtable, multirow}
% 英文使用 Times 字体
\usepackage{times}
% 源代码
\usepackage{fancyvrb}
% 自定义列表样式
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{algorithm}
\usepackage{algorithmic}

\usepackage{environ}
\NewEnviron{myequation}{%
\begin{equation}
\scalebox{0.88}{$\BODY$}
\end{equation}
}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 封面部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 国家图书馆封面内容字符串
% 仅博士需要填写并保证模板参数选择了 phd
% \classification{}
% \confidential{}
% \UDC{}
% \titlelinea{南京大学学位论文}
% \titlelineb{~\LaTeX{}~模板}
% \titlelinec{}
% \advisorinfo{南京大学~数学系}
% \chairman{XXX 教授}
% \reviewera{某某某某　副研究员}
% \reviewerb{XXX 教授}
% \reviewerc{XXX 教授}
% \reviewerd{XXX 教授}
% \nlcfootdate{2010~年~5~月~1~日}

% 南大中文封面内容字符串
\title{单相机动态人体三维重建}
\author{朱海宇}
\studentnum{~MF1423044}
\grade{2017}
\advisor{于耀~~副教授}
\major{计算机视觉}
\researchfield{三维重建}
\footdate{2010~年~5~月}
\submitdate{2010~年~5~月~10~日}
\defenddate{2010~年~6~月~1~日}

% 英文封面内容字符串
\englishtitle{Dynamic Human Body Modeling Using a Single RGB Camera}
\englishauthor{Haiyu Zhu}
\englishadvisor{Professor Yao Yu}
\englishinstitute{School of Electronic Science and Engineering}
\englishdegree{master}
\englishmajor{Computer Vision}
\englishdate{May 2017}

% 制作封面命令
\maketitle

% 制作英文封面命令
\makeenglishtitle


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 前言部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\frontmatter

% 中文摘要
\begin{abstract}

本文是南京大学学位论文的~\LaTeX{}~模板。目前不支持本科生学位论文格式。

除了介绍~\LaTeX{}~文档类~\texttt{NJUthesis}~的用法外，本文还是一
个简要的学位论文写作指南。

\keywords{南京大学; 学位论文; \LaTeX{}~模板}

\end{abstract}

% 英文摘要
\begin{englishabstract}

In this paper, we present a novel automatic pipeline to build personalized parametric models of dynamic people using a single RGB camera.
Compared to previous approaches that use monocular RGB images, our system can model a 3D human body automatically and incrementally, taking advantage of human motion.
Based on coarse 2D and 3D poses estimated from image sequences, we first perform a kinematic classification of human body parts to refine the poses and obtain reconstructed body parts.
Next, a personalized parametric human model is generated by driving a general template to fit the body parts and calculating the non-rigid deformation.
Experimental results show that our shape estimation method achieves comparable accuracy with reconstructed models using depth cameras, yet requires neither user interaction nor any dedicated devices, leading to the feasibility of using this method on widely available smart phones.

\englishkeywords{SCAPE, non-rigid reconstruction, single RGB camera, pose estimation, motion classification, structure from motion}

\end{englishabstract}

% 生成目录命令
\tableofcontents

% 以下两个目录可根据具体情况注释掉
% 生成表格目录命令
\listoftables
% 生成插图目录命令
\listoffigures


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 正文部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\mainmatter

\chapter{绪论}

\section{三维人体建模概述}

人体三维建模在游戏、计算机动画和虚拟试衣等领域都有着广泛的应用，并且在虚拟感知、计算机视觉和计算机图形学中它始终是学者们不断探讨的热点问题。
在过去的几十年中，学者们探索出了许多种方法来获取人体的三维模型，例如借助深度传感器获取深度图来重建人体三维模型~\cite{dou20153d,newcombe2015dynamicfusion,newcombe2011kinectfusion,zeng2013templateless,zhang2014quality}，利用三维的扫描仪获取人体三维模型的~\cite{anguelov2005scape,werghi2007segmentation}，还有借助多视角重建完成人体三维重建的~\cite{gall2009motion,huang2014human,liu2013markerless,robertini2014efficient,zollhofer2014real}模板。
这些方法的提出旨在更准确、更加快速的获取人体的三维模型。

\subsection{深度相机人体三维建模}
\label{sec:depth_sensor_modeling}

最近几年像Kinect这类深度相机的出现，使得我们可以通过深度图或者RGB-D图像重建出物体的三维模型。
Newcombe等人~\cite{newcombe2011kinectfusion}实现了一个名为KinectFusion的系统，它可以重建出场景比较精细的三维模型。
但是这个系统是有限制的，它需要借助深度相机并且只能应用于静态的场景。
基于此，Li, Tong, Weiss, Zeng等人~\cite{li20133d,tong2012scanning,weiss2011home,zeng2013templateless}把这个系统应用到人体三维模型重建中，只要我们拿着Kinect绕着一个保持固定姿势的人转一圈我们就可以得到这个人的三维模型。
Zhang等人~\cite{zhang2014quality}利用Kinect获取同一个人在不同姿势下的三维模型，然后将这些模型进行融合从而训练出这个人的参数化人体三维模型，之后就可以用这个参数化的模型模拟出这个人在各种姿态下的三维模型。
Newcombe等人~\cite{newcombe2015dynamicfusion}拓展了KinectFusion的应用场景，他们利用稠密体变换场(Dense Volumetric Warp-field)，借助Kiect相机可以重建出动态人的三维模型。
Bogo等人~\cite{bogodetailed}提出了一个名为Delta的多分辨率人体模型，可以从单目的RGB-D图像序列中恢复出动态人体的三维模型，并借助三维模型和图片上纹理随时间的变化来优化模型的体型。
Dou等人~\cite{dou20153d}通过非刚性光束平差法(Non-rigid Bundle Adjustment)优化最终模型的体型和每一帧模型的非刚性参数，从而使得系统能够获取动态的并且包含大量非刚性运动的动态物体的三维模型。

\subsection{多视角人体三维建模}
\label{sec:multi_view_modeling}

多视角三维重建主要是通过多个相机的不同视角，借助三角测量计算出场景的三维模型。
在重建之前我们需要对整个多相机系统进行标定。

Gall等人~\cite{gall2009motion}利用非监督的方法跟踪人体骨骼的运动并预测人体模型表面可能的非刚性形变，从而从一个多视角的图像序列中恢复出人体骨骼的运动以及人体模型表面的形变。
Liu等人~\cite{liu2013markerless}通过将参数化的人体三维模型和图像上人体的轮廓进行拟合从何推到出人体的体型和姿态。
Huang等人~\cite{huang2014human}提出了关键帧的概念以及一种外点排除方法。
他们将将关键帧处获取到的人体模型作为“参考模型”，随着“参考模型”数量的增多，系统就可以推断出某些视角下相机无法拍到的人体部位的可能形状从而排除数据中的噪声，因此提高了系统的鲁棒性。
Robertini等人~\cite{robertini2014efficient}提出了用三维高斯函数来表示人体体型的新方法，并将人体三维重建问题转化成连续图像序列中人体表面顶点全局优化的问题。
Zollhofer等人~\cite{zollhofer2014real}结合体融合方法和非刚性三维重建算法重实时的重建出人体的三维模型。

\subsection{单视角人体三维建模}
\label{sec:single_view_modeling}

虽然深度相机重建出来的模型精度较高，并且已经能够应用在动态的场景，但是，深度相机的成本却限制了这种重建法案的普及。
多相机三维重建需要多个相机配合工作，不仅整个三维重建系统的成本没有降低，而且使得重建系统环境搭建比较繁琐。
上面的种种因素都制约了深度相机和多相机进行三维重建的应用场景。
相比之下，单相机三维重建具备设备成本较低，系统搭建简单的优势，并且随着技术的发展，手机等移动设备使得用户可以简单快速的获取高质量的影像资料。
因此，单相机三维重建有着巨大的发展潜力，有着广阔的应用场景。

Guan等人~\cite{guan2009estimating}利用图像上人体轮廓、边缘和阴影信息将一个静态人体模型拟合到图像上，从而获取图像上人体的姿态和体型。
Hasler等人~\cite{hasler2010multilinear}利用双线性静态模型来获取单张图片上人的姿态和体型信息。
虽然多张图片可以提高他们系统的精度，但是他们重建出来模型的表面还是有许多的缺陷。
Jain等人~\cite{jain2010moviereshape}将参数化的三维模型投影到图片中的人体轮廓上，利用KLT(Kanade-Lucas-Tomasi)算法跟踪图像上手动标定的特征点，借此同时优化出图片中人物的三维体型和姿态。
除此之外，还有学者使用图片上的阴影获取人体三维形状~\cite{guan2009estimating}，利用参数化的模型拟合出人体模型~\cite{hasler2010multilinear,jain2010moviereshape,zhou2010parametric}，还有利用图像上人体轮廓信息作为问题的约束来求解重建问题的~\cite{guan2009estimating,huang2014human,liu2013markerless}。
其中，Zhou等人~\cite{zhou2010parametric}提出的方法是用计算出的SCAPE(Shape Completion and Animation for PEople)参数模型来匹配图片上人的体型，借此可以修改人体的体型参数来编辑图片上人的体型。
从阴影到结构的方法受限于光源的方向或者强度，而且多个光源的情况下会增加问题的难度；基于模型的方法需要一个比较好的参数化模型；基于轮廓的方法可能因单张照片上人体轮廓信息太少而不足以重建出质量较高的模型。
Yu等人~\cite{yu2015direct}先用SFM的方法获取一个人脸的三维模型，然后用这个模型来做人脸的实时动态重建。

\section{本文主要工作}

由于人体具有较高的灵活性，单个相机获取的获取的信息十分有限，因此自动化的动态人体的单相机三维重建一直是一个充满挑战的问题。
本文提出的方法能够借助一个普通的RGB相机自动的重建出一个动态的人体三维模型，如图~\ref{fig:introduction}。
图中第一行是我们通过相机获取的人体运动的序列，第二行是我们重建出来的每一帧中人体的三维模型。

\begin{figure}[ht]
  \centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=\textwidth]{figures/introduction.pdf}
  \caption{系统概要}
  \label{fig:introduction}
\end{figure}

在前人的工作中，人体的运动会使得问题的约束条件不足并最终导致重建结果的质量下降。
但是，通过对人体的运动分析我们发现：人体的运动可以提供一些额外的信息来帮助我们提高重建模型的质量。
因为单相机图像的获取其实是空间物体做投影变换，加上物体本身的遮挡这会使得物体很大一部分信息的丢失。
单如果物体能够运动起来，我们就可以在某个时间段捕获到之前丢失的一部分信息，借助这些信息我们就可以提高人体模型的重建精度。

虽然人体是一个比较复杂的非刚性体，但是由于人体骨骼的存在，人体所能产生的形变是有限的。
在人体运动过程中，我们先将人体运动的序列划分成很多时间段，然后利用人体运动变化的信息我们对每段时间中的人体从运动学上将人体划分成许多的“刚性块”，这样就将人体的非刚性重建问题退化成刚性物体的三维重建。
对于人体不同的“刚性快”，我们用它跟一个参数化的人体模型对应的部位进行融合变形。
随着数据的不断增加，参数化模型不同的身体部分跟真实的人体的实际模型之间的差距越来越小，最终得到一个精度较高的人体三维模型。
由于我们最终得到的模型本身是一个参数化的模型，因此我们可以将其变换到人体不同姿势下如图~\ref{fig:introduction}中第二行。

与~\ref{sec:depth_sensor_modeling}、~\ref{sec:multi_view_modeling}和~\ref{sec:single_view_modeling}中介绍的人体三维重建方法相比，本文所介绍的方法主要贡献如下：
\begin{itemize}
  \item 与深度相机重建相比，设备成本较低，能够重建出动态人体的三维模型；
  \item 与多相机重建相比，数据采集环境简单，不需要进行复杂的相机标定；
  \item 设计了一个运动学人体部位分类器，优化了人体~3D姿态精度；
  \item 是首个用普通~RGB~相机自动化重建出动态人体三维模型的系统。
\end{itemize}


\section{本文的章节组织形式}

\textbf{TODO}


\chapter{人体三维模型重建}
\label{chap:pipeline}

在这个章节中，我们将详细地介绍图~\ref{fig:pipeline}种展示的动态人体三维重建系统。
系统整体上可以分为以下几个主要步骤：

\begin{enumerate}
  \item 我们使用一个软件检测子来获取图像上人体~2D、~3D的关节点位置。因此不需要去手动标定图像上人体的关节点位置。
  \item 利用人体的运动学信息，我们优化了获取到的人体三维姿态信息，并将图像上的人体划分成许多刚性块的组合，使得动态人体三维重建从一个非刚性重建问题转换成刚性重建问题。
  \item 在不同的时间段，利用身体部位的光流并结合光束平差法(Bundle Adjustment)我们获得到人体不同部位的三维形状。随着越来越多的图像参投入到模型重建，不同身体部位重建的精度不断提高。
  \item 一个通用的参数化人体模型通过非刚性形变方法跟之前不同时间段获取到的人体不同部位的模型进行融合，并提取出人体运动过程中不同部位的刚性成分和非刚性成分。最终获取到人体体型模型，和每一帧下人体的三维模型。
\end{enumerate}

\begin{figure}[ht]
  \centering
  \includegraphics[width=\textwidth]{figures/pipeline.pdf}
  \caption{系统流程示意图}
  \label{fig:pipeline}
\end{figure}

\section{人体三维姿态检测}
\label{sec:pipeline_pose}

在我们的系统中，我们利用了Hasler等人~\cite{hasler2009statistical}提供的数据集，结合~Anguelov等人~\cite{anguelov2005scape}提供的方法训练出如图~\ref{fig:template}所示的~SCAPE~模型。
我们使用这个模型来解决重建过程中姿态变换和模型与不同刚性块的融合问题。

\begin{figure}[ht]
  \centering
  \subfigure[]{
    \includegraphics[height=0.5\textwidth]{figures/template1.png}
  }
  \subfigure[]{
    \includegraphics[height=0.5\textwidth]{figures/template2.png}
  }
  \caption{重建过程中使用的参数化模型。(a)：训练得到的~SCAPE~模型；(b)：模型的不同肢体部位。 }
  \label{fig:template}
\end{figure}

为了把~SCAPE~模型驱动到不同姿态下，我们就需要获取图片中人的三维姿态。
因此，我们对于每一帧图片都使用了~Yang等人~\cite{yang2011articulated}提供的2D人体姿态检测来获取图像上人体关节点的位置，然后使用~Wang等人~\cite{wang2014robust}的方法将图像上人体2D的姿态转换成3D的姿态。
接着，由于相邻帧图片上人体的运动是有一定关联性的，所以我们使用一个卡尔曼滤波器~\cite{kalman1960new}来优化我们得到2D、3D人体姿态，从而降低了错误的2D关节点对3D关节点的影响，提高系统的鲁棒性。
具体说来，因为相邻帧上的人体姿态变化是有一定的关联性，所以我们把人体3D的姿态看做是一个在时间上离散的线性动态系统。
我们假设 $P_i$ 表示第 $i$ 帧图片中人体的三维姿态，由于相邻帧中人体姿态具有较高的相关性，所以我们可以认为 $P_i$ 是由第 $i-1$ 帧上人体三维姿态 $P_i-1$ 变换而来。
这样一种动态关系我们可以用公式表示为：

\begin{equation}\label{eqn:Kalman_p}
  P_{i} = F_{i} P_{i-1} + B_{i} u_{i} + w_{i}
\end{equation}
其中 $F_{i}$ 是作用在前一时刻人体姿态 $P_{i-1}$ 上的状态转换模型，$B_{i}$ 是作用在控制向量 $u_i$ 上的控制输入模型。
$w_{i}$ 是系统中的过程噪声，并且满足常量协方差零均值的多元正态分布。
在第 $i$ 帧中，我们利用公式 \eqref{eqn:Kalman_Z} 获取人体真是三维姿态 $P_i$ 的估计值 $Z_i$

\begin{equation}\label{eqn:Kalman_Z}
  Z_i=H_iP_i+v_i
\end{equation}
其中 $H_i$ 是一个观测模型；$v_i$ 是系统的观测噪声，它是有常量协方差的零均值搞死白噪声模型~\cite{kalman1960new}。
从图像中获取到人体的三维姿态之后，我们就使用上述的卡尔曼滤波器结合从上一帧中获取的人体三维姿态来优化当前的人体三维姿态。

\section{运动学分类优化人体姿态}
\label{sec:pipline_classification}


虽然上面获取到的人体姿态已经提供了图像中人体部位分类的粗略信息，但是由于相机的透视投影、人体运动存在遮挡等因素，直接用前面获取到的人体姿态做人体部位分类是十分粗糙不准确的。
因为人体是靠骨骼支撑起来的，运动中骨骼的形变程度非常小，所以在较短的时间内我们可以忽略肢体部位表面的形变，认为该部位的运动是一个刚性体。
尽管人体上临近肢体间是靠关节连接的，但是属于不同肢体部位的运动是不同的。
在这里我们提出了一个运动学的分类器，借助人体不同部位的运动信息来比较准确的划分出人体的不同部位，从而进一步优化人体的二维、三维姿态，为后面重建出高质量的人体模型打下坚实的基础。
在物理学中，刚体是一个在运动中不发生任何形变的物体，换而言之，我们可以认为刚体在运动过程中都有着相似的位移。
根据之前获取的人体三维姿态并结合 SCAPE 模型，我们将人体划分成16个刚性块。
图 ~\ref{fig:kinematic_filter}说明了对图像上人体部位进行运动学分类的全过程。

\begin{figure}[h]
  \centering
  \includegraphics[width=\textwidth]{figures/silhouette.pdf}
  \caption{运动学分类步骤。
  (\textbf{a}) 将 SCAPE 模型投影到图像上获得包含分类信息的轮廓；
  (\textbf{b}) 图像中人体的轮廓；
  (\textbf{c}) SCAPE 模型轮廓和人体轮廓配准前；
  (\textbf{d}) 利用 CPD(coherent point drift~\cite{myronenko2010point}方法进行人体轮廓的匹配结果；
  (\textbf{e}) 借助 SCAPE 模型信息对图像上人体轮廓分类的结果；
  (\textbf{f}) 运动学分类结果。 首先，我们提取模型投影到图像上的轮廓以及图像上人体的轮廓； 然后，我们通过将 (\textbf{b}) 中人体轮廓和 (\textbf{a}) 中模型的轮廓进行配准并将人体轮廓进行分类得到 (\textbf{e}) 中结果。最后，我们利用全连通的条件随机场模型来获得图像上人体不同部位的分类结果 (\textbf{f})。}
  \label{fig:kinematic_filter}
\end{figure}

我们把每一帧图像看成是定义在变量 $\{I_1, \ldots, I_N\}$ 上的随机场 $\bf{I}$，其中 $I_i$ 是图像上像素 $i$ 所处位置 $p_i$ 处的像素值， $N$ 是图像上像素点的个数。
此外，随机场 $\bf{X}$ 是定义在变量集 $\{X_1, \ldots, X_N\}$ 上用来给每个像素 $i$ 确定其分类标签 $X_i$ 的。
我们用 $\mathbf{d_i}$ 来表示像素 $i$ 在相邻帧上的位移，并且通过由 Brox 和 Malik~\cite{brox2011large}提出的大位移光流算法来计算出位移的具体数值。
如公式~\eqref{eqn:Gibbs_Enegy}所示， 通过最小化条件随机场的吉布斯能量来获得每个像素的最优分类结果。

\begin{equation}\label{eqn:Gibbs_Enegy}
  E\left(\bf{I, X}\right)=\sum_i\psi_u\left(I_i, X_i\right)+\sum_{i<j}\psi_p\left(X_i,X_j,I_i,I_j\right)
\end{equation}
其中，变量 $i$ 和 $j$ 的取值范围是 $\left[1, N\right]$。
单点势能(unary potential) $\psi_u$ 由公式~\eqref{eqn:classifier}推导而出，它表示了标签 $X$ 和输入图像 $I$ 的匹配程度。

\begin{equation}\label{eqn:classifier}
\begin{aligned}
  &C\left(I_i, X_i\right)=
  \underbrace{\omega_{s}u_{s}\left(p_i,\mathbf{S}\left(X_i\right)\right)}_{silhouette} +
  \underbrace{\omega_{j}u_{j}\left(p_i,\mathbf{B}\left(X_i\right)\right)}_{joints} +
  \underbrace{\omega_{m}u_{m}\left(\mathbf{d_i},\mathbf{D}\left(X_i\right)\right)}_{motion}
  \\&s.t.\\
  &{\omega_s + \omega_j + \omega_m = 1}
\end{aligned}
\end{equation}
其中 {$\omega_s$, $\omega_j$} 和 {$\omega_m$} 是权重因子，并且 $\mathbf{S}\left(X_i\right)$ 表示每个分类标签 $X_i$ 所对应的图像上人体轮廓点。
因为 SCAPE 模型上有不同肢体部位所对应点集的信息，所以不同标签 $X_i$ 所对应的人体轮廓点可以通过将 SCAPE 模型投影到图像上，利用 CPD (Coherent Point Drift)~\cite{myronenko2010point}算法将模型的轮廓和人体的轮廓进行非刚性配准得到。
轮廓项能量 $u_s$ 是由计算图像上 $p_i$ 处的点和人体轮廓上点的最小二乘距离表示的。
\begin{equation}\label{eqn:clas_sil}
  u_s\left(p_i,\mathbf{S}\left(X_i\right)\right)=\exp\left(-\frac{\min\left(\left|p_i-\mathbf{S}\left(X_i\right)\right|^2\right)}{2\theta_s^2}\right)
\end{equation}
$\mathbf{B}\left(X_i\right)$ 是图像上被标记为 $X_i$ 的骨骼的重心。
因此，关节项能量 $u_j$ 通过公式~\eqref{eqn:clas_joint}计算得到。
\begin{equation}\label{eqn:clas_joint}
  u_j\left(p_i,\mathbf{B}\left(X_i\right)\right)=\exp\left(-\frac{\left|p_i - \mathbf{B}\left(X_i\right)\right|^2}{2\theta_j^2}\right)
\end{equation}
其中参数 $\theta_s$ 和 $\theta_j$ 控制图像上像素点间的连接强度和范围。

此外，我们提出了运动项能量 $u_m$ 来表示像素 $I_i$ 的运动跟刚性块 $X_i$ 的运动的匹配程度。
$\mathbf{D}\left(X_i\right)$ 表示标签为 $X_i$ 的骨骼的重心位移，这个是通过相邻帧上人体姿态的变化计算得到。

\begin{equation}\label{eqn:clas_move}
  u_m\left(\mathbf{d_i},\mathbf{D}\left(X_i\right)\right)=\rho_{\mathbf{d}}\left(1 + \frac{\mathbf{d_i}\bullet\mathbf{D}\left( X_i\right)}{\left|\mathbf{d_i}\right|\left|\mathbf{D}\left(X_i\right)\right|}\right)
\end{equation}
运动项能量通过评估像素 $I_i$ 和标签为 $X_i$ 的骨骼重心的位移匹配程度提高了图像上人体部位分类的精度。

公式~\eqref{eqn:Gibbs_Enegy}中成对点势能(pairwise potentials) $\psi_p$ 是由公式~\eqref{eqn:pair_wise}计算得到。

\begin{myequation}\label{eqn:pair_wise}
\begin{aligned}
  \psi_p&\left(X_i,X_j,I_i,I_j\right)=
  \mu\left(x_i,x_j\right)\exp\left(-\frac{\left|p_i-p_j\right|^2}{2\theta_{\alpha}^2}-\frac{\left|X_i-X_j\right|^2}{2\theta_{\beta}^2}\right)
  +\mu\left(x_i,x_j\right)\exp\left(u_m\left(\mathbf{d_i},\mathbf{d_j}\right)-1\right)
\end{aligned}
\end{myequation}
其中$\theta_{\alpha}$ 和 $\theta_{\beta}$ 参数表示了图像上像素点间的相似程度和临近程度。
标签兼容函数 $\mu\left(x_i,x_j\right)$ 通过波特模型得到，$\mu\left(x_i,x_j\right)=\left[x_i\not=x_j\right]$。
$\psi_p$ 的作用是处于某个区域中有相似运动的像素点更有可能属于同一个肢体部位。
我们使用由 Krahenbuhl等人~\cite{krahenbuhl2012efficient}实现的高效平均场求解方法来优化目标函数~\eqref{eqn:Gibbs_Enegy}。

为了检验公式~\eqref{eqn:classifier}中我们提出的运动项的有效性，我们让 $\omega_{m} = 0$，然后用同样的求解方法来求解上述的稠密条件随机场。
对比结果如图~\ref{fig:classification}所示，包含运动项所得到的分类结果(图中右边的结果)比没有利用运动项获得的结果(图中中间的结果)要精确很多。
有运动项存在的情况下人体的右腿和腹部之间的划分更加准确，并且在手臂遮挡住胸口的情况下也能准确区分手臂和胸部。

\begin{figure}[h]
 \centering
 % Requires \usepackage{graphicx}
 \includegraphics[width=0.8\textwidth]{figures/classification.pdf}
 \caption{身体部位运动学分类。 左边的是通过 RGB 相机获取的原始图像；中间的图是没有运动项参与时的分类结果；右边的结果表明在运动项的参与下分类的结果很精确并且能够处理有遮挡的情况。}
 \label{fig:classification}
\end{figure}


\section{稠密三维重建}
\label{sec:pipline_dense_rec}

通过对每一帧上的人体进行运动学的分类，利用相邻帧之间的稠密光流我们得到不同身体部位在相邻帧上的像素点之间的对应关系。
我们之所以选择用光流来获取点的对应关系，是因为在实际的情况中因身体部位的形变、肢体的运动会导致常见的特征检测只能得到十分稀疏的特征点对，特征点数量过少导致重建问题欠约束而无法求解。
换而言之，目前存在的特征检测方法只适用于静态场景，无法对包含非刚性形变的场景进行特征匹配。
我们把获取到的图像序列划分成许多较短的时间段，在这些时间段中对于某个特定的身体部位表面的形变就可以忽略不计，这样我们就把人体的非刚性重建转换成某个时间段中各个身体部位的刚性重建，也就可以使用从运动到结构的经典方法来获取人体不同部位的不同时间段的三维模型。
我们对不同身体部位进行三维重建的步骤通过算法~\ref{algo:dense_rec}进行了详细的说明。

\begin{algorithm}[h]
\caption{\textbf{Dense Reconstruction of Body Parts}}
\label{algo:dense_rec}
\begin{algorithmic}[1]
\STATE{$i$: the frame number of the input image}\vspace{6pt}
\STATE{$l_i^b$: the 2D barycenter of $B_b$ in the frame $f_i$}\vspace{6pt}
\STATE{$f_b$: the number of start frame of part $B_b$, denoted as ref for simplification}\vspace{6pt}
\FOR{$b\leftarrow 1 ~\TO ~16$}\vspace{6pt}
\IF{$\|l_i^b-l_{ref}^b\|>$ 30}\vspace{6pt}
\STATE{$T_{ref}^b \leftarrow T_{ref}^{'}$}\vspace{6pt}
\FOR{$j\leftarrow f_b+1 ~\TO ~i$}\vspace{6pt}
\STATE{$T_j^b\leftarrow\Delta{T_{ref\to{j}}^b}T_{ref}^b$}\vspace{6pt}
\STATE{derive dense optical flow from $f_{ref}$ to $f_j$ }\vspace{6pt}
\ENDFOR \vspace{6pt}
\STATE{$P^b\leftarrow \min E_{BA}$}\vspace{6pt}
\STATE{$f_b\leftarrow f_i$}\vspace{6pt}
\ENDIF \vspace{6pt}
\ENDFOR
\end{algorithmic}
\end{algorithm}

算法~\ref{algo:dense_rec}中 $f_i$表示 RGB 相机获取到的图像序列中的第 $i$ 帧图像，$B_i$ 表示人体上第 $i$ 个身体部位。
对于每个身体部位，我们认为它在较短时间内的运动是刚性的，因为身体部位表面的形变在这么短的时间内太小以致可以忽略不计。
我们使用 LDOF(Large Displacement Optical Flow)~\cite{brox2011large}算法计算不同帧之间亚像素级的稠密光流，并用稠密光流来跟踪身体部位在这较短时间内的运动，从而也就获得图像上身体部位点的对应关系。
当任意身体部位在图像上的连续运动距离超过阈值(20个像素)时，例如，身体部位 $B_b$ 的运动距离超过阈值时，我们选取 $f_b$ 帧(身体部位 $B_b$ 在图像上开始运动) 到 $f_i$ (身体部位 $B_b$ 在图像上的运动距离达到阈值)帧之间的所有帧，利用 $f_b$ 帧到 $f_i$ 帧之间相邻帧间的稠密光流获取到像素点之间的对应关系，我们利用光束平差法(Bundle Adjustment)就可以获取身体部位 $B_b$ 的三维模型。
身体部位在图像上运动范围的阈值是通过最小化公式~\eqref{eqn:BA}中的重投影误差来确定的。
当设置的阈值过小，进行重建时的短基线就会过短，从而导致算出点的深度值不精确，在公式~\eqref{eqn:BA}中体现为重投影误差较大。
如果设置的阈值过大，所选取的帧数就会较多，身体部位表面的非刚性形变较大而不能忽略，那么模型的重投影误差也会较大。
所以为了获得比较理想的阈值，我们先选一个比较小的阈值，然后将阈值逐渐增大。选取整个过程中重投影误差最小时的阈值作为我们最终的结果。
我们用 $\pi$ : $\Re^3\to\Re^2$ 表示投影函数，因此光束平差法的目标函数就是：

\begin{equation}\label{eqn:BA}
  E_{BA}=\sum_{j=f_b}^{i} \sum_{k \in B_b} \| p_{j}^k - \pi \left( r_j^bP_k + t_j^b \right) \|^2
\end{equation}
其中帧的索引是从 $f_b$ 变化到 $f_{i}$。
身体部位 $B_b$ 上第 $k$ 个点的三维空间位置我们用 $P_k$ 来表示，点 $P_k$ 在第 $j$ 帧上的投影是 $p_{j}^k$。
$T_j^b=\left[r_j^b|t_j^b\right]$ 表示相机在第 $j$ 帧时拍摄身体部位 $B_b$ 时相对的相机位置。
这里相机的相对位置 $T_j^b$ 是区别于相机的绝对位置 $T_j^\ast$ 的，相机相对位置不仅包含了身体部位 $B_b$ 的运动还包含了相机本身的运动。
以身体部位 $B_b$ 的运动为例，我们可以将参考帧 $f_b$ 对应的人体三维骨架驱动到当前帧 $j$ 帧下就可以获得相机对于身体部位 $B_b$ 的相对位置变换矩阵 $\Delta{T_{f_b\to{j}}^b}$。
因此，相机相对位置 $T_j^b = \Delta{T_{f_b\to{j}}^b} T_{f_b}^\ast$。

我们使用稀疏光束平差法~\cite{lourakis2009sba}来最小化代价函数~\eqref{eqn:BA}，并且所有点的初始深度值设定为2米到4米之间的随机值。
图~\ref{fig:dense_recons_gao}展示了我们利用亚像素级稠密点对应关系重建出的不同身体部位的稠密模型。
\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\textwidth]{figures/dense_reconstruction_gao.pdf}
  \caption{七个身体部位的稠密重建结果}
  \label{fig:dense_recons_gao}
\end{figure}

\section{分解人体表面形变}
\label{sec:pipeline_rigid_motion}

在这章中，我们将人体表面的形变分解成刚性成分和非刚性的成分。
由于人体在运动过程中人的体型是不会发生改变的，所以人体表面的刚性成分主要是由人体体型参数和衣服的刚性运动部分组成。
为了得到人体运动的刚性部分和非刚性部分，我们对上面重建出来的人体各部位三维模型进行进一步处理。
将已知的 SCAPE 模型和重建出来的人体部位模型结合起来，利用非刚性形变算法将 SCAPE 模型和不同时间段重建出来的人体部位模型进行融合得到模型的许多实例，然后对这些实例的运动进行分解，得到运动中人体模型表面的刚性形变和非刚性形变成分。

\subsection{模型实例获取}
\label{sec:pipline_deform_template}

在人体运动过程中，人体模型上的刚性成分是指人体模型运动过程一直保持不变的成分，它跟人的姿态变化没有任何关系。
换而言之，即便是在不同的时间不同的姿态下人体模型上的同一部位的刚性部分都是相同的。
由于上述重建算法在某个时间区间中重建的模型可能只是几个肢体部位(如图~\ref{fig:dense_recons_gao})而不是一个完整的人体模型，并且这些模型只是包含了人体模型上的几何信息并没有详细的语义信息。
所以，为了获取到当前人体模型的刚性部分，我们需要将之前在运动学分类~\ref{sec:pipline_classification}中使用的 SCAPE 模型和不同时刻肢体部位模型的进行非刚性融合，从而将人体模型上的刚性、非刚性部分分解转化为 SCAPE 模型上的刚性、非刚性分解。
虽然从图~\ref{fig:template}中可以看出我们使用的 SCAPE 模型和我们目标人体模型之间的差异是很大，但是，从运动学分类优化人体姿态~\ref{sec:pipline_classification}一节以及本章节中可以看出 SCAPE 模型和目标模型之间的巨大差异对我们的人体部位分类和人体模型成分分解并没有多大影响，这也表明了我们系统的鲁棒性很高，泛化能力很强。

首先，我们利用之前从图片中获得的人体三维姿态将 SCAPE 模型驱动到当前图片中人体的姿态下，然后用 Z-buffer 算法获取该姿态下相机所能获取到的 SCAPE 模型的前景部分，再将前景部分不同的身体部位跟它对应的稠密三维重建结果借助 CPD 算法进行非刚性融合，融合之后我们还获得了 SCAPE 模型和稠密重建模型上的点对应关系。
融合之后的 SCAPE 模型就是当前帧下面人体模型的一个实例，部分结果可以参考图~\ref{fig:deform_template}。

\begin{figure}[h]
 \centering
 \includegraphics[width=\textwidth]{figures/deform_template.pdf}
 \caption{当前帧下 SCAPE 模型跟上肢人体部位融合得到的实例。左边的图是非刚性融合之前 SCAPE 模型被驱动到当前帧中人体姿态下的结果，以及 Z-buffer 算法获取到的 SCAPE 模型的前景部分。 右图是通过将当前姿态下 SCAPE 模型对应部位的前景跟稠密重建模型进行非刚性融合得到的一个实例。}
 \label{fig:deform_template}
\end{figure}

为了检验 SCAPE 模型和稠密模型进行非刚性融合的结果，我们计算了融合之后的 SCAPE 实例上所有点跟稠密模型上的对应点之间的欧氏距离并将其作为融合误差，通过将融合误差映射到颜色空间来直观表示身体不同部位的融合误差结果，融合误差见图~\ref{fig:deformation_error_map}。
如图所示，SCAPE 模型进行非刚性融合的结果是可以接受的。对应点之间最大的误差只有 0.5 cm，并且只是左手臂上的一小部分。
SCAPE 上前景部分参与融合的点数是 2689，因此得到的平均融合误差仅仅为 0.8 mm。
尽管融合结果包含一些噪声点，但是这些噪声是可容忍的并且对后面的结果几乎不会产生什么影响。

\begin{figure}[h]
\centering
\includegraphics[width=0.5\textwidth]{figures/deformation_error_map.pdf}
\caption{SCAPE 模型和稠密重建结果融合误差图。}
\label{fig:deformation_error_map}
\end{figure}

\subsection{模型刚性、非刚性成分分解}
\label{pipline_calc_rigid_comp}

每次 SCAPE 模型和重建出来的肢体部位稠密模型融合都会得到一个 SCAPE 模型的实例，我们将得到的所有 SCAPE 实例结合起来推导出实例间的变换矩阵，通过对变换矩阵进行分解而得到人体模型运动过程中的刚性成分和非刚性成分。
我们模型的形变计算是使用类似于训练 SCAPE 时所用的方法，我们这里的 SCAPE 实例就类似于~\cite{anguelov2005scape}中训练集。
我们用一个 $3\times3$ 矩阵 $D_k^j$ 来表示 SCAPE 模型上第 $k$ 个三角面片从初始状态下表换到第 $j$ 处实例时的形变矩阵，$D_k^j$ 是通过最小化目标函数~\eqref{eqn:D^j_R^j}得到。

\begin{equation}\label{eqn:D^j_R^j}
\begin{aligned}
  \min_{D^j, R^j}\sum_k\sum_{l=2,3}\rho\|R_k^jD_k^j\hat{u}_{k,l}-u_{k,l}^j\|^2
  + \rho\omega_d\sum_{k_1,k_2}\|D_{k_1}^j-D_{k_2}^j\|^2
\end{aligned}
\end{equation}
其中，$R_k^j$ 代表刚性旋转矩阵，并且 $\hat{u}_{k,l}=v_{k,l}-u_{k,1}, l=2,3$ 表示我们 SCAPE 模型上三角面片 $k$ 的两条边。
同样，$u_{k,l}^j$ 代表实例 $j$ 上三角面片 $k$ 的两条边 $u_{k,l}^j$。
$\rho$ 是一个指示函数，在对实例 $j$ 上三角面片 $k$ 进行形变之后， $\rho=1$; 否则， $\rho=0$。
$\omega_d=1e^{-3}$ 不仅可以用来避免相邻三角面片间发生较大的形变，还减少稠密模型上噪声点对模型运动成分分解的负面影响。
因为形变矩阵 $D_k^j$ 和旋转矩阵 $R_k^j$ 都是未知的，所以目标函数~\eqref{eqn:D^j_R^j}完全是非线性的。
对于优化这种目标函数，我们通过给旋转矩阵 $R_k^j$ 设定一个初值，然后求解 $D_k^j$，然后利用 $D_k^j$ 来更新旋转矩阵的值，然后再求解 $D_k^j$，如此反复迭代的分别求解 $D_k^j$，$R_k^j$ 直到目标函数收敛于某处极值。
求解的具体过程是：在求解出 $D_k^j$ 之后，旋转矩阵 $R_k^j$ 可以通过扭 $\omega$，$R_k^{j~new}\leftarrow\left(\mathbf{I}+\left[\omega\right]_\times\right)R_k^{j~old}$ 来更新它的值，其中 $\left[\cdot\right]_\times$ 表示叉乘矩阵。
所以，当计算出一个 $D_k^j$ 值之后，我们最小化目标函数~\eqref{eqn:omega}得到扭 $\omega$。

\begin{equation}\label{eqn:omega}
\begin{aligned}
  \min_{\omega^j}\sum_k\sum_{l=2,3}\rho\|\left(\mathbf{I}+\left[\omega\right]_\times\right)R_k^jD_k^j\hat{u}_{k,l}-u_{k,l}^j\|^2
  +\omega_t\sum_{b1,b2}\|\omega_{b_1}-\omega_{b2}\|^2
\end{aligned}
\end{equation}
其中，$b_1$ 和 $b_2$ 分别表示相邻的两个肢体部位。
在反复迭代计算 $D_k^j$ 和 $R_k^j$ 的值直到收敛于某处极值，就得到实例跟初始 SCAPE 模型之间的形变矩阵 $D^j$。

因为我们的初始 SCAPE 模型包含了 $K$ 个三角面片， 因此每个实例相对于初始模型的形变矩阵 $D^j$ 可以转换成一个维度为 $9\times K$ 的向量，而这个 $9\times K$ 的向量可以由一个线性子空间生成：$D^j=U\beta^j+\mu$。
这里 $\mu$ 是就是模型运动中的刚性成分，这个可以通过计算 $D^j$ 的均值得到。
当我们获得的实例数量足够多时，我们可以通过 PCA(Principal Component Analysis)很容易的推导出模型运动过程中的非刚性成分 $\beta^j$。

\chapter{结果和讨论}

\section{定性分析}

\section{定量分析}

\section{对比}

\chapter{结论}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 附件部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\backmatter

% 参考文献
% 使用 BibTeX，不使用 BibTeX 时注释掉下面一句。
\bibliography{template}

% 不使用 BibTeX
%\begin{thebibliography}{2}
%
%\bibitem{deng:01a}
%{邓建松,~彭冉冉,~陈长松}.
%\newblock {\em \LaTeXe{}~科技排版指南}.
%\newblock 科学出版社,~书号:~7-03-009239-2/TP.1516, 北京, 2001.
%
%\bibitem{wang:00a}
%王磊.
%\newblock {\em \LaTeXe{}~插图指南}.
%\newblock 2000.
%\end{thebibliography}

% 本章可以删去
\Nchapter{简历与科研成果}

\noindent {\heiti 基本情况}
\vspace{1ex}

\noindent 杨文博，男，汉族，1986~年~11~月出生，河南省民权县人。

\vspace{2ex}
\noindent {\heiti 教育背景}

\begin{description}[labelindent=0em, leftmargin=8em, style=sameline]

\item[2007.9～2010.6] 中国科学院研究生院信息安全国家重点实验室 \hfill 硕士

\item[2003.9～2007.6] 南京大学数学系 \hfill 本科

\end{description}

% 发表文章目录
\vspace{5ex}
\begin{Publications}{2}

\item Wenbo Yang and Wen Tao Zhu, ``Voting-on-Grid Clustering for Secure
  Localization in Wireless Sensor Networks,'' in \emph{Proc. IEEE
  International Conference on Communications (ICC) 2010}, May. 2010.

\item Wenbo Yang and Wen Tao Zhu, ``Protecting Source Location Privacy in
Wireless Sensor Networks with Data Aggregation,'' in \emph{Proc. 7th
International Conference on Ubiquitous Intelligence and Computing (UIC) 2010},
Oct. 2010.

\end{Publications}

\vspace{4ex}
\noindent {\heiti 攻读硕士学位期间参与的科研课题}

\begin{enumerate}[label=\arabic*., labelindent=0em, leftmargin=*]

\item 国家自然科学基金面上项目``无线传感器网络在知识获取过程中的若干安全问题研究''
(课题年限~2010.1～2012.12)，负责位置相关安全问题的研究。

\item 中国科学院知识创新工程重要方向项目下属课题``下一代移动通信安全机制研究''
(课题年限~2010.1～2010.12)，负责~LTE/SAE~认证相关的安全问题研究。

\end{enumerate}

  % 致谢
%\begin{thanks}
%\vskip 18pt
%
%首先感谢XXX
%
%\end{thanks}


\end{document}
